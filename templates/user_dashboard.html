<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å›¾ä¹¦ç®¡ç†ç³»ç»Ÿ - ç”¨æˆ·é¢æ¿</title>
    <link
      rel="icon"
      href="{{ url_for('static', filename='images/book1.png') }}"
      type="image/png"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style_admin.css') }}"
    />
  </head>
  <body>
    {% with messages = get_flashed_messages() %} {% if messages %}
    <div class="error-popup">
      {% for message in messages %} {{ message }} {% endfor %}
    </div>
    {% endif %} {% endwith %}
    <!-- Sidebar navigation -->
    <div class="sidebar">
      <div class="logo">
        <h2>å›¾ä¹¦ç®¡ç†ç³»ç»Ÿ</h2>
        <p>ç”¨æˆ·é¢æ¿</p>
      </div>

      <div class="nav-links">
        <a href="#" class="nav-link active" data-section="book-search">
          <i>ğŸ”</i>
          <span>å›¾ä¹¦æŸ¥è¯¢</span>
        </a>
        <a href="#" class="nav-link" data-section="borrow-book">
          <i>ğŸ“–</i>
          <span>å€Ÿä¹¦</span>
        </a>
        <a href="#" class="nav-link" data-section="return-book">
          <i>ğŸ“š</i>
          <span>è¿˜ä¹¦</span>
        </a>

        <div class="logout">
          <a href="{{ url_for('logout') }}" class="nav-link">
            <i>ğŸšª</i>
            <span>é€€å‡ºç™»å½•</span>
          </a>
        </div>
      </div>
    </div>

    <!-- Main content area -->
    <div class="main-content">
      <div class="header">
        <h1>æ¬¢è¿å›æ¥ï¼Œç”¨æˆ·</h1>
        <div class="date-time" id="datetime"></div>
      </div>

      <!-- Content Area -->
      <div class="content-area">
        <!-- å›¾ä¹¦æŸ¥è¯¢ -->
        <div class="section active" id="book-search">
          <h2>å›¾ä¹¦æŸ¥è¯¢</h2>
          <br />
          <form action="{{ url_for('search') }}" method="POST">
            <div class="search-bar">
              <input
                type="text"
                id="search-title"
                name="title"
                placeholder="ä¹¦å"
                class="narrow-input"
              />
              <input
                type="text"
                id="search-author"
                name="author"
                placeholder="ä½œè€…"
                class="narrow-input"
              />
              <input
                type="text"
                id="search-category"
                name="category"
                placeholder="ç±»åˆ«"
                class="narrow-input"
              />
              <input
                type="text"
                id="search-publisher"
                name="publisher"
                placeholder="å‡ºç‰ˆç¤¾"
                class="narrow-input"
              />
              <input
                type="number"
                id="year-start"
                name="year_start"
                placeholder="èµ·å§‹å¹´ä»½"
                class="narrow-input"
              />
              <input
                type="number"
                id="year-end"
                name="year_end"
                placeholder="ç»“æŸå¹´ä»½"
                class="narrow-input"
              />
              <input
                type="number"
                step="0.01"
                id="price-min"
                name="price_min"
                placeholder="æœ€ä½ä»·æ ¼"
                class="narrow-input"
              />
              <input
                type="number"
                step="0.01"
                id="price-max"
                name="price_max"
                placeholder="æœ€é«˜ä»·æ ¼"
                class="narrow-input"
              />
              <select id="sort-by" name="sort_by">
                <option value="book_id">ä¹¦å·</option>
                <option value="title">æŒ‰ä¹¦åæ’åº</option>
                <option value="category">æŒ‰ç±»åˆ«æ’åº</option>
                <option value="publisher">æŒ‰å‡ºç‰ˆç¤¾æ’åº</option>
                <option value="year">æŒ‰å¹´ä»½æ’åº</option>
                <option value="author">æŒ‰ä½œè€…æ’åº</option>
                <option value="price">æŒ‰ä»·æ ¼æ’åº</option>
              </select>
              <p>&ensp;&ensp;</p>
              <select id="order-by" name="order_by">
                <option value="asc">é€’å¢</option>
                <option value="desc">é€’å‡</option>
              </select>
              <button
                type="button"
                id="search_button"
                name="is_search"
                value="true"
              >
                ğŸ”
              </button>
            </div>

            <div class="card">
              <h3>æŸ¥è¯¢ç»“æœ</h3>
              <table>
                <thead>
                  <tr>
                    <th>ä¹¦å·</th>
                    <th>ç±»åˆ«</th>
                    <th>ä¹¦å</th>
                    <th>å‡ºç‰ˆç¤¾</th>
                    <th>å¹´ä»½</th>
                    <th>ä½œè€…</th>
                    <th>ä»·æ ¼</th>
                    <th>æ€»è—ä¹¦é‡</th>
                    <th>åº“å­˜</th>
                  </tr>
                </thead>
                <tbody id="books-table-body">
                  <!-- åŠ¨æ€åŠ è½½æ•°æ® -->
                </tbody>
              </table>
            </div>
          </form>
        </div>

        <!-- å€Ÿä¹¦ -->
        <div class="section" id="borrow-book">
          <h2>å·²å€Ÿä¹¦ç±æŸ¥è¯¢</h2>
          <br />
          <form action="{{ url_for('borrow') }}" method="post">
            <input type="hidden" name="search_borrowered_books" value="true" />
            <div class="search-bar">
              <input
                type="text"
                id="search-id"
                placeholder="è¾“å…¥å€Ÿä¹¦è¯å¡å·"
                name="card_id"
              />
              <select id="sort-by-borrow" name="sort_by_borrow">
                <option value="book_id">ä¹¦å·</option>
                <option value="title">ä¹¦å</option>
                <option value="author">ä½œè€…</option>
                <option value="press">å‡ºç‰ˆç¤¾</option>
                <option value="year">å¹´ä»½</option>
                <option value="price">ä»·æ ¼</option>
                <option value="total_nums">æ€»è—ä¹¦é‡</option>
                <option value="stock">åº“å­˜</option>
              </select>
              <select id="order-by-borrow" name="order_by_borrow">
                <option value="asc">é€’å¢</option>
                <option value="desc">é€’å‡</option>
              </select>
              <button
                type="button"
                id="search_button_borrow"
                name="is_search"
                value="true"
              >
                ğŸ”
              </button>
            </div>
            <div class="card">
              <h3>æŸ¥è¯¢ç»“æœ</h3>
              <table>
                <thead>
                  <tr>
                    <th>ä¹¦å·</th>
                    <th>ç±»åˆ«</th>
                    <th>ä¹¦å</th>
                    <th>å‡ºç‰ˆç¤¾</th>
                    <th>å¹´ä»½</th>
                    <th>ä½œè€…</th>
                    <th>ä»·æ ¼</th>
                    <th>æ€»è—ä¹¦é‡</th>
                    <th>åº“å­˜</th>
                  </tr>
                </thead>
                <tbody id="borrowered-books-table-body">
                  <!-- Data will be loaded here dynamically -->
                </tbody>
              </table>
            </div>
          </form>

          <h2>å€Ÿä¹¦</h2>
          <br />
          <div class="card">
            <h3>å€Ÿä¹¦æ“ä½œ</h3>
            <form action="{{ url_for('borrow') }}" method="post">
              <input type="hidden" name="borrow_book" value="true" />
              <div class="form-group">
                <label for="card-id">å€Ÿä¹¦è¯å¡å·</label>
                <input
                  type="text"
                  id="card-id"
                  name="card_id"
                  placeholder="è¯·è¾“å…¥å€Ÿä¹¦è¯å¡å·"
                  required
                />
              </div>

              <div class="form-group">
                <label for="book-id">ä¹¦å·</label>
                <input
                  type="text"
                  id="book-id"
                  name="book_id"
                  placeholder="è¯·è¾“å…¥å›¾ä¹¦ç¼–å·"
                  required
                />
              </div>

              <button type="submit" class="btn btn-primary">å€Ÿä¹¦</button>
            </form>
          </div>
        </div>

        <!-- è¿˜ä¹¦ -->
        <div class="section" id="return-book">
          <h2>å·²å€Ÿä¹¦ç±æŸ¥è¯¢</h2>
          <br />
          <form action="{{ url_for('returns') }}" method="post">
            <input type="hidden" name="search_borrowered_books" value="true" />
            <div class="search-bar">
              <input
                type="text"
                id="search-id-returns"
                placeholder="è¾“å…¥å€Ÿä¹¦è¯å¡å·"
                name="card_id"
              />
              <select id="sort-by-returns" name="sort_by">
                <option value="book_id">ä¹¦å·</option>
                <option value="title">ä¹¦å</option>
                <option value="author">ä½œè€…</option>
                <option value="press">å‡ºç‰ˆç¤¾</option>
                <option value="year">å¹´ä»½</option>
                <option value="price">ä»·æ ¼</option>
                <option value="total_nums">æ€»è—ä¹¦é‡</option>
                <option value="stock">åº“å­˜</option>
              </select>
              <select id="order-by-returns" name="order_by">
                <option value="asc">é€’å¢</option>
                <option value="desc">é€’å‡</option>
              </select>
              <button
                type="button"
                id="search_button_borrow_returns"
                name="is_search"
                value="true"
              >
                ğŸ”
              </button>
            </div>
            <div class="card">
              <h3>æŸ¥è¯¢ç»“æœ</h3>
              <table>
                <thead>
                  <tr>
                    <th>ä¹¦å·</th>
                    <th>ç±»åˆ«</th>
                    <th>ä¹¦å</th>
                    <th>å‡ºç‰ˆç¤¾</th>
                    <th>å¹´ä»½</th>
                    <th>ä½œè€…</th>
                    <th>ä»·æ ¼</th>
                    <th>æ€»è—ä¹¦é‡</th>
                    <th>åº“å­˜</th>
                  </tr>
                </thead>
                <tbody id="borrowered-books-table-body-returns">
                  <!-- Data will be loaded here dynamically -->
                </tbody>
              </table>
            </div>
          </form>

          <h2>è¿˜ä¹¦</h2>
          <br />
          <div class="card">
            <h3>è¿˜ä¹¦æ“ä½œ</h3>
            <form action="{{ url_for('returns') }}" method="post">
              <input type="hidden" name="return_book" value="true" />
              <div class="form-group">
                <label for="card-id">å€Ÿä¹¦è¯å¡å·</label>
                <input
                  type="text"
                  id="card-id"
                  name="card_id"
                  placeholder="è¯·è¾“å…¥å€Ÿä¹¦è¯å¡å·"
                  required
                />
              </div>

              <div class="form-group">
                <label for="book-id">ä¹¦å·</label>
                <input
                  type="text"
                  id="book-id"
                  name="book_id"
                  placeholder="è¯·è¾“å…¥å›¾ä¹¦ç¼–å·"
                  required
                />
              </div>

              <button type="submit" class="btn btn-primary">è¿˜ä¹¦</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Update date and time
      function updateDateTime() {
        const now = new Date();
        const options = {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        };
        document.getElementById("datetime").textContent =
          now.toLocaleDateString("zh-CN", options);
      }

      updateDateTime();
      setInterval(updateDateTime, 60000);

      // Tab switching for navigation
      const navLinks = document.querySelectorAll(".nav-link");
      const sections = document.querySelectorAll(".section");

      navLinks.forEach((link) => {
        if (link.parentElement.classList.contains("logout")) return;

        link.addEventListener("click", (e) => {
          e.preventDefault();

          // Remove active class from all links and sections
          navLinks.forEach((l) => l.classList.remove("active"));
          sections.forEach((s) => s.classList.remove("active"));

          // Add active class to clicked link
          link.classList.add("active");

          // Show corresponding section
          const sectionId = link.getAttribute("data-section");
          document.getElementById(sectionId).classList.add("active");
        });
      });

      // å›¾ä¹¦æŸ¥è¯¢
      document.addEventListener("DOMContentLoaded", function () {
        // é¡µé¢åŠ è½½æ—¶é»˜è®¤æ˜¾ç¤º 10 æ¡å›¾ä¹¦ä¿¡æ¯
        loadBooks();

        // æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document
          .getElementById("search_button")
          .addEventListener("click", function () {
            loadBooks();
          });

        // æœç´¢æ¡†å›è½¦äº‹ä»¶
        document.querySelectorAll(".search-bar").forEach(function (input) {
          input.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              e.preventDefault();
              loadBooks();
            }
          });
        });

        function loadBooks() {
          const requestData = {
            title: document.getElementById("search-title").value || "",
            author: document.getElementById("search-author").value || "",
            category: document.getElementById("search-category").value || "",
            year_start: document.getElementById("year-start").value || "",
            year_end: document.getElementById("year-end").value || "",
            price_min: document.getElementById("price-min").value || "",
            price_max: document.getElementById("price-max").value || "",
            sort_by: document.getElementById("sort-by").value || "title",
            order_by: document.getElementById("order-by").value || "asc",
          };

          fetch('{{ url_for("search") }}', {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Requested-With": "XMLHttpRequest",
            },
            body: JSON.stringify(requestData),
          })
            .then((response) => response.json())
            .then((data) => {
              //console.log('Fetched books data:', data);
              updateBooksTable(data);
            })
            .catch((error) => console.error("Error fetching books:", error));
        }

        function updateBooksTable(books) {
          const tableBody = document.getElementById("books-table-body");
          tableBody.innerHTML = "";

          if (books && books.length > 0) {
            books.forEach((book) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                            <td>${book.book_id}</td>
                            <td>${book.category}</td>
                            <td>${book.title}</td>
                            <td>${book.press}</td>
                            <td>${book.year}</td>
                            <td>${book.author}</td>
                            <td>${book.price}</td>
                            <td>${book.total_nums}</td>
                            <td>${book.stock}</td>
                        `;
              tableBody.appendChild(row);
            });
          } else {
            const row = document.createElement("tr");
            row.innerHTML =
              '<td colspan="9" style="text-align: center;">æ— æ»¡è¶³æ¡ä»¶çš„å›¾ä¹¦</td>';
            tableBody.appendChild(row);
          }
        }
      });
      // å€Ÿä¹¦æŸ¥è¯¢-å€Ÿä¹¦
      document.addEventListener("DOMContentLoaded", function () {
        // é¡µé¢åŠ è½½æ—¶é»˜è®¤æ˜¾ç¤º 10 æ¡å›¾ä¹¦ä¿¡æ¯
        loadBooks_borrowed();

        // æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document
          .getElementById("search_button_borrow")
          .addEventListener("click", function () {
            loadBooks_borrowed();
          });

        // æœç´¢æ¡†å›è½¦äº‹ä»¶
        document.querySelectorAll(".search-bar").forEach(function (input) {
          input.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              e.preventDefault();
              loadBooks_borrowed();
            }
          });
        });

        function loadBooks_borrowed() {
          const requestData = {
            card_id: document.getElementById("search-id").value || "",
            sort_by_borrow:
              document.getElementById("sort-by-borrow").value || "book_id",
            order_by_borrow:
              document.getElementById("order-by-borrow").value || "asc",
          };
          fetch('{{ url_for("borrow") }}', {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Requested-With": "XMLHttpRequest",
            },
            body: JSON.stringify(requestData),
          })
            .then((response) => response.json())
            .then((data) => {
              //console.log('Fetched books data:', data);
              updateBooksTable_borrowed(data);
            })
            .catch((error) => console.error("Error fetching books:", error));
        }

        function updateBooksTable_borrowed(books) {
          const tableBody = document.getElementById(
            "borrowered-books-table-body"
          );
          tableBody.innerHTML = "";

          if (books && books.length > 0) {
            books.forEach((book) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                            <td>${book.book_id}</td>
                            <td>${book.category}</td>
                            <td>${book.title}</td>
                            <td>${book.press}</td>
                            <td>${book.year}</td>
                            <td>${book.author}</td>
                            <td>${book.price}</td>
                            <td>${book.total_nums}</td>
                            <td>${book.stock}</td>
                        `;
              tableBody.appendChild(row);
            });
          } else {
            const row = document.createElement("tr");
            row.innerHTML =
              '<td colspan="9" style="text-align: center;">æ— æ»¡è¶³æ¡ä»¶çš„å›¾ä¹¦</td>';
            tableBody.appendChild(row);
          }
        }
      });
      // å€Ÿä¹¦æŸ¥è¯¢-è¿˜ä¹¦
      document.addEventListener("DOMContentLoaded", function () {
        // é¡µé¢åŠ è½½æ—¶é»˜è®¤æ˜¾ç¤º 10 æ¡å›¾ä¹¦ä¿¡æ¯
        loadBooks_borrowed_returns();

        // æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document
          .getElementById("search_button_borrow_returns")
          .addEventListener("click", function () {
            loadBooks_borrowed_returns();
          });

        // æœç´¢æ¡†å›è½¦äº‹ä»¶
        document.querySelectorAll(".search-bar").forEach(function (input) {
          input.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              e.preventDefault();
              loadBooks_borrowed_returns();
            }
          });
        });

        function loadBooks_borrowed_returns() {
          const requestData = {
            card_id: document.getElementById("search-id-returns").value || "",
            sort_by:
              document.getElementById("sort-by-returns").value || "book_id",
            order_by:
              document.getElementById("order-by-returns").value || "asc",
          };

          fetch('{{ url_for("returns") }}', {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Requested-With": "XMLHttpRequest",
            },
            body: JSON.stringify(requestData),
          })
            .then((response) => response.json())
            .then((data) => {
              //console.log('Fetched books data:', data);
              updateBooksTable_borrowed_returns(data);
            })
            .catch((error) => console.error("Error fetching books:", error));
        }

        function updateBooksTable_borrowed_returns(books) {
          const tableBody = document.getElementById(
            "borrowered-books-table-body-returns"
          );
          tableBody.innerHTML = "";

          if (books && books.length > 0) {
            books.forEach((book) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                            <td>${book.book_id}</td>
                            <td>${book.category}</td>
                            <td>${book.title}</td>
                            <td>${book.press}</td>
                            <td>${book.year}</td>
                            <td>${book.author}</td>
                            <td>${book.price}</td>
                            <td>${book.total_nums}</td>
                            <td>${book.stock}</td>
                        `;
              tableBody.appendChild(row);
            });
          } else {
            const row = document.createElement("tr");
            row.innerHTML =
              '<td colspan="9" style="text-align: center;">æ— æ»¡è¶³æ¡ä»¶çš„å›¾ä¹¦</td>';
            tableBody.appendChild(row);
          }
        }
      });
    </script>
  </body>
</html>
